<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多语对照记忆工具 v4.3</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .options-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.25rem;
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background: var(--bg-color);
            border-radius: 0.75rem;
        }
        .option-group.full-width { grid-column: 1 / -1; }
        .option-group label {
            display: flex; align-items: center; gap: 0.5rem;
            font-weight: 500; margin-bottom: 0.25rem;
        }
        .option-group select,
        .option-group input[type="file"],
        .option-group input[type="number"] {
            width: 100%; padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem; font-size: 0.95rem; background: #fff;
        }
        .option-group select:focus,
        .option-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.15);
        }
        .checkbox-inline {
            display: flex; align-items: center; gap: 0.5rem;
            font-size: 0.95rem; cursor: pointer;
        }
        .checkbox-inline input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .model-desc { font-size: 0.82rem; color: var(--text-secondary); margin-top: 0.25rem; }
        .model-detail {
            font-size: 0.82rem; color: var(--text-secondary); margin-top: 0.35rem;
            display: flex; gap: 1.5rem;
        }
        .model-detail span { font-weight: 600; }
        .model-detail .id-val { color: #0066cc; }
        .model-detail .output-val { color: #009900; }

        /* 阈值网格 */
        .section-panel {
            margin-bottom: 1.5rem; padding: 1.25rem;
            background: var(--bg-color); border-radius: 0.75rem;
        }
        .section-panel h3 {
            font-size: 1rem; margin-bottom: 0.75rem;
            display: flex; align-items: center; gap: 0.5rem;
        }
        .threshold-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
        }
        .threshold-grid .th-item {
            display: flex; align-items: center; gap: 0.35rem;
        }
        .threshold-grid .th-item label {
            font-size: 0.9rem; white-space: nowrap; min-width: 2.5rem;
            margin-bottom: 0;
        }
        .threshold-grid .th-item input {
            width: 100%; padding: 0.35rem 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem; font-size: 0.9rem; background: #fff;
        }
        .buffer-row {
            margin-top: 0.75rem; display: flex; align-items: center; gap: 0.5rem;
        }
        .buffer-row input { width: 100px; }
        .hint-text {
            font-size: 0.82rem; color: #0066cc; margin-top: 0.4rem;
            display: flex; align-items: center; gap: 0.35rem;
        }

        .result-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1rem; margin-bottom: 1.5rem;
        }
        .summary-card {
            background: var(--card-bg); padding: 1.25rem;
            border-radius: 0.75rem; box-shadow: var(--shadow-md); text-align: center;
        }
        .summary-card i { font-size: 1.5rem; color: var(--primary-color); margin-bottom: 0.4rem; }
        .summary-card h3 { font-size: 1.6rem; margin-bottom: 0.15rem; }
        .summary-card p { color: var(--text-secondary); font-size: 0.85rem; }
        .issues-list {
            background: #fffbeb; border: 1px solid #fde68a;
            border-radius: 0.5rem; padding: 1rem; margin-top: 1rem; font-size: 0.9rem;
        }
        .issues-list h4 { color: #92400e; margin-bottom: 0.5rem; }
        .issues-list ul { padding-left: 1.25rem; color: #78350f; }

        .stream-log-wrap {
            margin-top: 1.5rem; background: #1e1e2e;
            border-radius: 0.5rem; padding: 1rem;
            max-height: 400px; overflow: hidden;
        }
        .stream-log-wrap h4 { color: #cdd6f4; margin-bottom: 0.5rem; font-size: 0.95rem; }
        .stream-log {
            margin: 0; padding: 0.75rem; background: #11111b;
            border-radius: 0.375rem; color: #a6e3a1;
            font-size: 0.82rem; line-height: 1.5;
            white-space: pre-wrap; word-break: break-all;
            max-height: 340px; overflow: auto;
        }
        .collapse-toggle {
            cursor: pointer; user-select: none;
            color: var(--primary-color); font-size: 0.85rem;
            display: inline-flex; align-items: center; gap: 0.25rem;
        }
        .collapse-toggle i { transition: transform 0.2s; }
        .collapse-toggle.collapsed i { transform: rotate(-90deg); }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <i class="fas fa-language"></i>
                <h1>多语对照记忆工具 v4.3</h1>
            </div>
            <p class="subtitle">上传原文与译文文档，AI 自动句级对齐，输出 Excel 双语对照表</p>
        </header>

        <main class="main-content">
            <!-- 上传区 -->
            <section class="upload-section" id="uploadSection">
                <div class="upload-card">
                    <h2>上传待对齐文档</h2>
                    <p class="upload-desc">支持 DOCX / DOC / PPTX / XLSX / XLS，需同时上传原文和译文</p>

                    <!-- 语言设置 -->
                    <div class="options-panel">
                        <div class="option-group">
                            <label><i class="fas fa-globe"></i> 原文语言:</label>
                            <select id="sourceLang"></select>
                        </div>
                        <div class="option-group">
                            <label><i class="fas fa-globe-americas"></i> 译文语言:</label>
                            <select id="targetLang"></select>
                        </div>
                        <div class="option-group full-width" style="display:flex;align-items:center;gap:1.5rem;">
                            <label class="checkbox-inline">
                                <input type="checkbox" id="enablePostSplit" checked>
                                <span>启用后处理细粒度分句（英文等西方语言按句号细分，自动排除缩写）</span>
                            </label>
                        </div>
                        <div class="option-group full-width hint-text" id="langHint">
                            <i class="fas fa-info-circle"></i>
                            <span id="langHintText">当源语言为英文等西方语言时，会在LLM对齐后进一步按句号细分</span>
                        </div>
                    </div>

                    <!-- 文件选择 -->
                    <div class="options-panel">
                        <div class="option-group full-width">
                            <label><i class="fas fa-file-alt"></i> <span id="origFileLabel">原文文件 (中文):</span></label>
                            <input type="file" id="originalFile" accept=".docx,.doc,.pptx,.xlsx,.xls">
                        </div>
                        <div class="option-group full-width">
                            <label><i class="fas fa-file-alt"></i> <span id="transFileLabel">译文文件 (英语):</span></label>
                            <input type="file" id="translatedFile" accept=".docx,.doc,.pptx,.xlsx,.xls">
                        </div>
                    </div>

                    <!-- 模型选择 -->
                    <div class="options-panel">
                        <div class="option-group">
                            <label><i class="fas fa-robot"></i> 选择模型:</label>
                            <select id="modelSelect"></select>
                            <div class="model-desc" id="modelDesc"></div>
                        </div>
                        <div class="option-group">
                            <label>&nbsp;</label>
                            <div class="model-detail">
                                <div>模型ID: <span class="id-val" id="modelIdDisplay">-</span></div>
                                <div>最大输出: <span class="output-val" id="modelMaxOutput">-</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- 处理选项（阈值） -->
                    <div class="section-panel">
                        <h3>
                            <i class="fas fa-cog"></i> 处理选项（仅对 DOCX 生效）
                            <span class="collapse-toggle" id="thresholdToggle" onclick="toggleThresholds()">
                                <i class="fas fa-chevron-down"></i> 展开
                            </span>
                        </h3>
                        <div id="thresholdPanel" style="display: none;">
                            <label style="font-size:0.9rem;margin-bottom:0.5rem;display:block;">分割阈值（字数）：</label>
                            <div class="threshold-grid">
                                <div class="th-item">
                                    <label>2份:</label>
                                    <input type="number" id="threshold2" value="25000">
                                </div>
                                <div class="th-item">
                                    <label>3份:</label>
                                    <input type="number" id="threshold3" value="50000">
                                </div>
                                <div class="th-item">
                                    <label>4份:</label>
                                    <input type="number" id="threshold4" value="75000">
                                </div>
                                <div class="th-item">
                                    <label>5份:</label>
                                    <input type="number" id="threshold5" value="100000">
                                </div>
                                <div class="th-item">
                                    <label>6份:</label>
                                    <input type="number" id="threshold6" value="125000">
                                </div>
                                <div class="th-item">
                                    <label>7份:</label>
                                    <input type="number" id="threshold7" value="150000">
                                </div>
                                <div class="th-item">
                                    <label>8份:</label>
                                    <input type="number" id="threshold8" value="175000">
                                </div>
                                <div class="th-item">
                                    <label>缓冲:</label>
                                    <input type="number" id="bufferChars" value="2000">
                                    <span style="font-size:0.85rem;">字</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 按钮 -->
                    <div style="display: flex; gap: 12px;">
                        <button class="btn-secondary" onclick="window.location.href='/'">
                            <i class="fas fa-arrow-left"></i> 返回导航
                        </button>
                        <button class="btn-primary" id="btnStart" style="max-width: 360px;">
                            <i class="fas fa-play"></i> 开始处理
                        </button>
                    </div>
                </div>
            </section>

            <!-- 处理中 -->
            <section class="processing-section" id="processingSection" style="display: none;">
                <div class="processing-card">
                    <div class="spinner"></div>
                    <h2 id="processingTitle">文档对齐处理中...</h2>
                    <p id="processingText">正在调用 AI 进行句级对齐</p>
                    <div class="progress-container" style="margin-top: 24px;">
                        <div class="progress-bar-wrapper">
                            <div class="progress-bar" id="progressBar">
                                <span id="progressPercent" class="progress-percent">0%</span>
                            </div>
                        </div>
                        <div class="progress-details" id="progressDetails">
                            <p id="progressStep">初始化...</p>
                        </div>
                    </div>
                    <div class="stream-log-wrap" id="streamLogWrap" style="display: none;">
                        <h4><i class="fas fa-terminal"></i> 实时输出（模型输出流 + 运行日志）</h4>
                        <pre class="stream-log" id="streamLog"></pre>
                    </div>
                </div>
            </section>

            <!-- 结果 -->
            <section class="result-section" id="resultSection" style="display: none;">
                <div class="result-header">
                    <h2><i class="fas fa-check-circle"></i> 对齐完成</h2>
                    <button class="btn-secondary" id="btnReset">
                        <i class="fas fa-rotate-right"></i> 重新开始
                    </button>
                </div>
                <div class="result-summary" id="resultSummary"></div>
                <div class="result-grid" id="resultGrid"></div>
            </section>
        </main>
    </div>

    <script>
    function toggleThresholds() {
        const panel = document.getElementById('thresholdPanel');
        const toggle = document.getElementById('thresholdToggle');
        if (panel.style.display === 'none') {
            panel.style.display = 'block';
            toggle.innerHTML = '<i class="fas fa-chevron-down"></i> 收起';
            toggle.classList.remove('collapsed');
        } else {
            panel.style.display = 'none';
            toggle.innerHTML = '<i class="fas fa-chevron-down"></i> 展开';
            toggle.classList.add('collapsed');
        }
    }
    </script>
    <script src="/static/alignment.js"></script>
</body>
</html>
